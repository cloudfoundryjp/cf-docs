<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>サービスのバインド</title>

    <link href="../../../stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../../../javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_using docs_using_services docs_using_services_node-service-bindings">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='header'>
        <div class='container_wide'>
          <ul class='actions'>
            <li class='last'>
              <a href="http://www.cloudfoundry.com/contact">Contact Us</a>
            </li>
            <li>
              <a class='register_link' href='http://login.run.pivotal.io/login'>My Account</a>            
            </li>
          </ul>
        </div>
      </div>
      <div id='content'>
        <div class='logo-main'>
          <div class='logo'>
            <a href='http://www.cloudfoundry.com'>
            <img src='/images/logo-cloudfoundry.png'>
            </a>
            <a href='http://www.gopivotal.com' target="_blank">
            <img id="pivotal-logo" src='/images/logo-pivotal.png'>
            </a>
          </div>
          <div class='cta'>
            <a href='https://console.run.pivotal.io'>
            <img src='/images/signup_freetrial.png'>
            </a>
          </div>
        </div><!-- End of logo-main-->
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                <li>
                <a href='docs/using/' id='use'>Cloud Foundryを利用する</a>
                </li>
                <li>
                <a href='docs/running/' id='run'>Cloud Foundryを実行する</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/getinvolved' id='getinvolved'>貢献するには</a>
                </li>
                <li id='docs-off'>
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="../">Cloud Foundryを使用する</a></li> <li class=""><a href="./">サービスを利用する</a></li> <li class="active"><span>サービスのバインド</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"><ul>
<li><a href="#intro">紹介</a></li>
<li><a href="#prerequisites">前提</a></li>
<li><a href="#creating">サービスを作成する</a></li>
<li><a href="#autoconfig">自動設定</a></li>
<li><a href="#Connecting">サービスへ接続する</a>

<ul>
<li><a href="#module-support">適切なモジュールのサポートを追加する</a></li>
</ul></li>
<li><a href="#mongodb">Mongodb</a></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#rabbitmq">Rabbit MQ</a></li>
<li><a href="#binding">Binding a service</a></li>
</ul>
</div>

              <h1>サービスのバインド</h1>

            
            <p><strong>注意:</strong> このページで述べるオート・コンフィギュレーションは、Cloud Foundry v2では未だサポートされていません。</p>

<h2><a id='intro'></a>紹介</h2>

<p>本ガイドは、Cloud Foundry上で実行されるNode.jsアプリケーションの開発者向けです。</p>

<h2><a id='prerequisites'></a>前提</h2>

<ul>
<li>Cloud Foundryのアカウント。右のページでサインアップできます。<a href="https://my.cloudfoundry.com/signup">サインアップ</a></li>
<li>The <a href="../../managing-apps/index.html">CF</a> コマンド・ライン・ツール</li>
<li><a href="http://www.nodejs.org">Node.js</a> Cloud Foundryインスタンスへ適切なヴァージョンのNODE.jsをインストールする。</li>
<li><a href="http://npmjs.org/">NPM</a> - アプリの依存関係などを管理するNodeパッケージマネージャー</li>
<li>サンプル・アプリケーションは<a href="./">このチュートリアル</a>にあります。</li>
</ul>

<h3><a id='creating'></a> サービスを作成する</h3>

<p>サービスを作るには、以下のようにcfコマンドを実行し、対話的に質問に答えます;</p>
<div class="highlight"><pre><span class="nv">$ </span>cf create-service
</pre></div>
<h2><a id='autoconfig'></a>自動設定</h2>

<p>以下のようなサービスがNode.jsアプリケーションにバインドされている時、Cloud Foundryが自動的に設定します。</p>

<ul>
<li>Rabbit MQ via the &#39;<a href="https://github.com/postwait/node-amqp">ampq</a>&#39; module</li>
<li>Mongo via the &#39;<a href="http://mongodb.github.com/node-mongodb-native/">mongodb</a>&#39;
and &#39;<a href="http://mongoosejs.com/">mongoose</a>&#39; modules</li>
<li>MySQL via the &#39;<a href="https://github.com/felixge/node-mysql">mysql</a>&#39; module</li>
<li>Postgres via the &#39;<a href="https://github.com/brianc/node-postgres">pg</a> module</li>
<li>Redis via the &#39;<a href="https://github.com/mranney/node_redis">redis</a>&#39; module</li>
</ul>

<p>この時点でアプリケーションはポート3000で待ち受けます。アプリケーションに手を加えずにデプロイするために、プロジェクトへcf-autoconfig
node モジュールを追加します。以下の二箇所を変更し、cf-autoconfigをpackage.jsonへ追加します。</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-node&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;cf-autoconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;engines&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;0.8.x&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>アプリケーションの先頭でこのライブラリをrequireします;</p>
<div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cf-autoconfig&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello from Cloud Foundry&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>
<p>通常通りアプリケーションをデプロイすると、ポートが自動的に割当てられ、接続が行なわれます。自動設定を使いたくなければ、環境変数から得たポートへ接続するようアプリを変更するだけです;</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello from Cloud Foundry&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
</pre></div>
<h2><a id='Connecting'></a> サービスへ接続する</h2>

<p>アプリケーションにrecord_visitという関数を追加してみましょう。これは訪問者のIPアドレスと日付を記録する、接続のデモンストレーションです。</p>

<h3><a id='module-support'></a> 適切なモジュールのサポートを追加する</h3>

<p>package.jsonを編集し、dependenciesセクションへ該当モジュールを追加します。通常、一つだけが必要ですが、念のためすべて追加することにします。</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-node&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;cf-autoconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;mongodb&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;mongoose&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;mysql&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pg&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;redis&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ampq&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;engines&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;0.8.x&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>次に、app.jsを編集し、接続の内容はブランクにしておきます。普段はホストのアドレスやポートやユーザ名とパスワードを書く部分です。</p>

<h3><a id='mongodb'></a> Mongodb</h3>
<div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cf-autoconfig&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;ips&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="nx">object_to_insert</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;ip&#39;</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">};</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span> <span class="nx">object_to_insert</span><span class="p">,</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object_to_insert</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span> <span class="o">~~~~</span>

<span class="err">###</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">id</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="o">&gt;&lt;</span><span class="err">/a&gt; Redis ##</span>

<span class="o">~~~</span><span class="nx">javascript</span>
<span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cf-autoconfig&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">),</span>
  <span class="nx">client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;last_ip&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello from Cloud Foundry&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>
<h3><a id='mysql'></a> MySQL</h3>
<div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cf-autoconfig&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">mysql</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mysql&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">();</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT NOW() as time_now;&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">time_now</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The solution is: &#39;</span><span class="p">,</span> <span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>
<h3><a id='rabbitmq'></a> Rabbit MQ</h3>
<div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cf-autoconfig&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">amqp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;amqp&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">amqp</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">();</span>

  <span class="c1">// Wait for connection to become established.</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Use the default &#39;amq.topic&#39; exchange</span>
    <span class="nx">connection</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="s1">&#39;my-queue&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">q</span><span class="p">){</span>
        <span class="c1">// Catch all messages</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">);</span>

        <span class="c1">// Receive messages</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Print messages to stdout</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>
<h3><a id='binding'></a> Binding a service</h3>

<p>サービスとアプリケーションをバインドするためには、以下のcfコマンドを実行してください;</p>
<div class="highlight"><pre><span class="nv">$ </span>cf <span class="nb">bind</span>-service --app <span class="o">[</span>application name<span class="o">]</span> --service <span class="o">[</span>service name<span class="o">]</span>
</pre></div>
          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
          <li>
          <a href='http://www.cloudfoundry.com/about'>About</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://blog.cloudfoundry.com/'>Blog</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/partners'>Partners</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://docs.cloudfoundry.com'>Docs</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/faq'>FAQ</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://status.cloudfoundry.com/'>Status</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/support'>Support</a>
          </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            GoPivotal, Inc. All rights reserved.
            <a href='http://www.cloudfoundry.com/terms'>Terms</a>
            <a href='http://www.gopivotal.com/privacy-policy' target='_blank'>Privacy</a>
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
