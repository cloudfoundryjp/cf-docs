<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Health Manager</title>

    <link href="../../../stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../../../javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_architecture docs_running_architecture_health-manager">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='header'>
        <div class='container_wide'>
          <ul class='actions'>
            <li class='last'>
              <a href="http://www.cloudfoundry.com/contact">Contact Us</a>
            </li>
            <li>
              <a class='register_link' href='http://login.run.pivotal.io/login'>My Account</a>            
            </li>
          </ul>
        </div>
      </div>
      <div id='content'>
        <div class='logo-main'>
          <div class='logo'>
            <a href='http://www.cloudfoundry.com'>
            <img src='/images/logo-cloudfoundry.png'>
            </a>
            <a href='http://www.gopivotal.com' target="_blank">
            <img id="pivotal-logo" src='/images/logo-pivotal.png'>
            </a>
          </div>
          <div class='cta'>
            <a href='https://console.run.pivotal.io'>
            <img src='/images/signup_freetrial.png'>
            </a>
          </div>
        </div><!-- End of logo-main-->
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                <li>
                <a href='http://www.cloudfoundry.com/use' id='use'>Using Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/run' id='run'>Running Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/getinvolved' id='getinvolved'>Get Involved</a>
                </li>
                <li id='docs-off'>
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="../">Running Cloud Foundry</a></li> <li class=""><a href="./">Architecture</a></li> <li class="active"><span>Health Manager</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"></div>

              <h1>Health Manager</h1>

            
            <p>Health Manager monitors the state of the applications and ensures that started applications are indeed running, their versions and number of instances correct.</p>

<p>Conceptually, this is done by maintaining a Known State of applications and comparing it against the Expected State. When discrepancies are found, actions are initiated to bring the applications to the Expected State, e.g., start/stop commands are issued for missing/extra instances, respectively.</p>

<p>Additionally, Health Manager collects and exposes statistics and health status for individual applications, as well as aggregates for frameworks, runtimes, etc.</p>

<h2>AppState</h2>

<p>The state of each application is represented by an instance of an aptly named class <code>AppState</code>. <code>AppState</code> gets forwarded important state-changing messages (i.e. hearbeats and exit signals), updates its internal state accordingly and then invokes registered event handlers. It is the job of these handlers (housed in the Harmonizer, see below) to enforce complex policies, e.g., whether to restart application, if so, with which priority, etc.</p>

<h2>Components</h2>

<p>Health Manager is comprised of the following components:</p>

<ul>
<li>Manager</li>
<li>Harmonizer</li>
<li>Scheduler</li>
<li>ExpectedStateProvider</li>
<li>KnownStateProvider</li>
<li>Nudger</li>
<li>Reporter</li>
<li>Shadower</li>
</ul>

<h3>Manager</h3>

<p>Provides an entry point, configures, initializes and registers other components.</p>

<h3>Harmonizer</h3>

<p>Expresses the policy of bringing the applications to the Expected State by observing the Known State.</p>

<p>Harmonizer sets up the interactions between other components, and aims to achieve clarity of the intent through delegation:</p>

<p>Known State and Expected State are compared periodically with the use of the Scheduler and Nudger actions are Scheduled to bring the States into harmony.</p>

<h3>Scheduler</h3>

<p>Encapsulates EventMachine-related functionality such as timer setup and cancellation, quantization of long-running tasks to prevent EM Reactor loop blocking.</p>

<h3>Expected State Provider</h3>

<p>Provides the expected state of the application, e.g., whether the application was started or stopped, how many instances should be running, etc. This information comes from the <a href="cloud-controller.html">Cloud Controller</a> by way of HTTP-based Bulk API, hence the concrete class is <code>BulkBasedExpectedStateProvider</code>.</p>

<p>The Bulk API contains the state of the world as the Cloud Controller says it should be. This is a dump of the CC_DB database. It might differ from what the world actually looks like, and the Harmonizer will attempt to make the current state match this expected state.</p>

<h3>Known State Provider</h3>

<p>The Known State will be discovered from <code>NatsBasedKnownStateProvider</code>, that will listen to heartbeat and other messages on the <a href="messaging-nats.html">NATS</a> bus.</p>

<p>The state of each application is represented by an instant of object <code>AppState</code>. That object receives updates of the application state, stores them and notifies registered listeners about events, such as <code>instances_missing</code>, etc.</p>

<h3>Nudger</h3>

<p>Nudger is the interface for Health Manager to effect the change on the world, by dispatching <code>cloudcontrollers.hm.requests</code> messages that instruct Cloud Controller nodes to start or stop instances. Nudger maintains a priority queue of these requests, and deques the messages by a batchful.</p>

<h3>Reporter</h3>

<p>Reporter responds to <code>healthmanager.status</code> and <code>healthmanager.health</code> requests.</p>

<h3>Shadower</h3>

<p>The Shadower component exists primarily to smooth the transition from the Health Manager v1 to Health Manager v2.</p>

<p>The Shadower implements shadow-mode for Health Manager v2, where it quietly and passively observes the state of the world and comes up with harmonization decisions, but rather than publishing harmonization messages on the NATS bus, it keeps track of them. It also listens for harmonization messages (most likely coming from Health Manager v1) and compares those messages with the ones Health Manager v2 has produced. Ideally, these two sets of messages should perfectly overlap. When they don&#39;t, Shadower issues warnings.</p>

<p>When in shadow-mode, all outgoing messages are sent to the Shadower, rather than being published to NATS.</p>

<h2>Harmonization Policy in Detail</h2>

<p>Conceptually, harmonization happens in two ways:</p>

<ul>
<li>by reacting to messages (such as <code>droplet.exited</code>)</li>
<li>by periodically scanning the world and enumerating applications, looking for anomalies</li>
</ul>

<h3>droplet.exited signal</h3>

<p>There are three distinct scenarios possible when <code>droplet.exited</code> signal arrives:</p>

<ul>
<li><p>application is stopped; means the application was stopped explicitly, no action required;</p></li>
<li><p><a href="execution-agent.html">DEA</a> evacuation; the DEA is being evacuated and all instances from that DEA need to be restarted somewhere else. Health Manager v2 initiates that restarting;</p></li>
<li><p>application instance crashed; That instance needs to be restarted unless it crashed multiple times in short period of time, in which case it is declared <code>flapping</code>. See more on this below.</p></li>
</ul>

<h3>Flapping instances</h3>

<p>An instance of application is declared &ldquo;flapping&rdquo; if it crashed more than <code>flapping_death</code> times within <code>flapping_timeout</code> seconds. There are several possible reasons for flapping:</p>

<ul>
<li>app is completely broken and simply does not start</li>
<li>app has a bug that results in a crash every once in a while</li>
<li>app has a dependency on the external world or a CF-provisioned service, and that dependency is unavailable, perhaps temporarily, resulting in app repeatedly crashing</li>
</ul>

<p>Handling flapping apps is hard. We&#39;d like to:</p>

<ul>
<li>make the best effort to restart an app, when it makes sense</li>
<li>provide the crashlogs for crashing instances</li>
<li>cut down on the overhead associated with restarting an app, particularly relating to moving application bits to DEA and storing it there</li>
<li>avoid IO spikes due to massive simultaneous restarts</li>
</ul>

<p>In order to accomodate these conflicting requirements, the following policy for flapping instances (FI) adopted:</p>

<ul>
<li>initially the FI is restarted with a delay defined by <code>min_restart_delay</code> config value</li>
<li>for each subsequent crash, the delay is doubled, but not to exceed <code>max_restart_delay</code> config value</li>
<li>a random noise is added to the value of delay, its maximum absolute value defined by <code>delay_time_noise</code> config value</li>
<li>if the number of crashes for a given FI exceeds <code>giveup_crash_number</code>, give up restarting attempts; this behavior can be turned off</li>
</ul>

<h3>Heartbeat processing</h3>

<p>DEAs peridically send out heartbeat messages on NATS bus. These heartbeats contain DEA identifying information, as well as information on application instances running on respective DEAs.</p>

<p>The heartbeats are used to establish &ldquo;missing&rdquo; and &ldquo;extra&rdquo; indices. Missing indices are then commanded to start, extra indices are commanded to stop.</p>

<p><code>AppState</code> object tracks heartbeats for each instance of each version.</p>

<p>An instance is &ldquo;missing&rdquo; if a live version of this instance has not received a heartbeat in the last <code>droplet_lost</code> seconds.</p>

<p>However, an <code>instance_missing</code> event is only triggered if the <code>AppState</code> was not reset recently, and if <code>check_for_missing_instances</code> method has been invoked.</p>

<h2>Configuration</h2>

<p>Health Manager reads its configuration from a YAML file. Look at the <a href="https://github.com/cloudfoundry/health_manager/blob/master/config/health_manager.yml">example config file</a> for an explanation of all the configurable variables.</p>

<h2>Logs</h2>

<p>Health Manager uses <a href="http://github.com/cloudfoundry/steno">Steno</a> to manage its logs. The <code>logging</code> key in the config file provides information for Steno configuration.</p>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
          <li>
          <a href='http://www.cloudfoundry.com/about'>About</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://blog.cloudfoundry.com/'>Blog</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/partners'>Partners</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://docs.cloudfoundry.com'>Docs</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/faq'>FAQ</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://status.cloudfoundry.com/'>Status</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/support'>Support</a>
          </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            GoPivotal, Inc. All rights reserved.
            <a href='http://www.cloudfoundry.com/terms'>Terms</a>
            <a href='http://www.gopivotal.com/privacy-policy' target='_blank'>Privacy</a>
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
